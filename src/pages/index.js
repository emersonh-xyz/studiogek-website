import Head from 'next/head'
import React, { useEffect, useState } from 'react'
import { useSession, signOut, signIn } from 'next-auth/react'
import Navbar from '@/components/Navbar';
import PostCard from '@/components/PostCard';
import fetchUserTier from '@/utils/fetch_user_tier';
import fetchCampaignPosts from '@/utils/fetch_campaign_posts'
import { useRouter } from 'next/router';
import { Container, Card, Row, Text, Grid } from "@nextui-org/react";


export default function Patreon() {

  const { data: session, status } = useSession()

  const [userTier, setUserTier] = useState();
  const [postData, setPostData] = useState([]);

  const router = useRouter();

  // Get all of the posts from the campaign
  const getPosts = async () => {
    const results = await fetchCampaignPosts();
    setPostData(results.data);
  }

  // Get the current tier of the user
  const getTier = async () => {
    const results = await fetchUserTier();
    setUserTier(results);
  }

  useEffect(() => {

    // Call our asyncronous functions
    getTier()
    getPosts()

    return () => {
      // this now gets called when the component unmounts
    }


  }, [])
  // Loop over all post data
  const PostItems = () => {
    return (
      postData.map((data) => {
        return <PostCard key={data.id} props={data} content={data.attributes.content} />
      })
    )
  }

  if (status === "loading") {
    return <p>Loading...</p>
  }

  if (status === "unauthenticated") {
    router.push("/login?redirect_to=/patreon")
  }



  return (
    <>
      <Head>
        <title>Studio Gek | Home</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <header>
        <Navbar />
      </header>

      <main>
        <Container>


          {postData &&

            <Grid.Container gap={2} justify="start">
              < PostItems />
            </Grid.Container >
          }


        </Container >

      </main >

      <footer>

      </footer>

    </>
  )
}